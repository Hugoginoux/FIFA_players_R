# Data 

## Sources

The dataset is under the form of 1 csv per year and per gender. We want to load everything, and merge them into a single data.frame.

```{r merging_female}
fem_16 = read.csv('data/female_players_16.csv')
fem_16$release_year = '2016'

fem_17 = read.csv('data/female_players_17.csv')
fem_17$release_year = '2017'

fem_18 = read.csv('data/female_players_18.csv')
fem_18$release_year = '2018'

fem_19 = read.csv('data/female_players_19.csv')
fem_19$release_year = '2019'

fem_20 = read.csv('data/female_players_20.csv')
fem_20$release_year = '2020'

fem_21 = read.csv('data/female_players_21.csv')
fem_21$release_year = '2021'

fem_22 = read.csv('data/female_players_22.csv')
fem_22$release_year = '2022'

female_players = rbind(fem_16, fem_17, fem_18, fem_19, fem_20, fem_21, fem_22)
```


```{r merging_male}
male_15 = read.csv('data/players_15.csv')
male_15$release_year = '2015'

male_16 = read.csv('data/players_16.csv')
male_16$release_year = '2016'

male_17 = read.csv('data/players_17.csv')
male_17$release_year = '2017'

male_18 = read.csv('data/players_18.csv')
male_18$release_year = '2018'

male_19 = read.csv('data/players_19.csv')
male_19$release_year = '2019'

male_20 = read.csv('data/players_20.csv')
male_20$release_year = '2020'

male_21 = read.csv('data/players_21.csv')
male_21$release_year = '2021'

male_22 = read.csv('data/players_22.csv')
male_22$release_year = '2022'

male_players = rbind(male_15, male_16, male_17, male_18, male_19, male_20, male_21, male_22)

```

```{r merging both}
female_players$gender = 'F'
male_players$gender = 'M'

all_players = rbind(female_players, male_players)

head(all_players)
```

## Cleaning (from ls to gk, turn into numeric)

Some quantitative features are encoded under the form '55+3' for instance. We should therefore treat these values by keeping only the 2 first characters and turning them into integers.

```{r cleaning}
defaultW <- getOption("warn")
options(warn = -1)


clean_col=function(dataset, col){
  column = dataset[, col]
  
  str_to_num = function(x){
    return(as.numeric(substr(x, 1, 2)))
  }
  
  return(sapply(column, FUN = str_to_num))
}


for (col in c("ls","st","rs","lw","lf","cf","rf","rw","lam","cam","ram","lm","lcm","cm","rcm","rm","lwb","ldm","cdm","rdm","rwb","lb","lcb","cb","rcb","rb","gk")){
    #print(col)
    all_players[,col]=clean_col(all_players, col)
    male_players[,col]=clean_col(male_players, col)
    female_players[,col]=clean_col(female_players, col)
    male_22[,col]=clean_col(male_22, col)
    fem_22[,col]=clean_col(fem_22, col)
}


```

## Missing value analysis

Let's start by checking how many missing values are in each column. 

```{r count_missing}
library(tidyverse)
# get counts of missing values
colSums(is.na(all_players)) %>%
  sort(decreasing = TRUE)
```

We see that we have a lot of missing values for columns such as nation_team_id, nation_jersey_number, goalkeeping_speed, etc. These are because we have players that do not play for the national team or that do not goalkeep, so they have no values for these variables. This is not a big deal, we will not be using these variables in our analysis. 

We can't visualize these missing values with a heatmap because we have too many samples (players) in our dataset. We will plot the percentage of missing values for each column that has missing values instead. 

```{r missing_val_hm}
library(forcats)

# get number of rows in the dataset 
nr = nrow(all_players)

# get percentage of missing values 
missing_vals = colSums(is.na(all_players)) %>%
  sort(decreasing = TRUE)
missing_vals = missing_vals / nr

# remove columns that have no missing values 
missing_vals = missing_vals[missing_vals > 0]

# melt the data
melted_missing_vals = reshape2::melt(missing_vals) %>%
  mutate(
    variable = rownames(.), 
    .before = 1
  )
rownames(melted_missing_vals) = NULL

# plot 
melted_missing_vals %>%
  ggplot(aes(x = fct_reorder(variable, -value), y = value)) + 
  geom_bar(stat = 'identity', fill = 'black') + 
  scale_y_continuous(
    limits = c(0, 1), 
    breaks = c(0, 0.25, 0.5, 0.75, 1), 
    labels = scales::percent
  ) +
  labs(
    x = 'Variable', 
    y = 'Percent Missing', 
    title = 'Percent of Missing Values'
  ) + 
  theme_classic() + 
  theme(
    axis.title.x = element_text(face = 'bold', size = 15, vjust = -0.5), 
    axis.title.y = element_text(face = 'bold', size = 15, vjust = 2),
    axis.text.x = element_text(size = 12, angle = 90, hjust = 1, vjust = 0.5), 
    axis.text.y = element_text(size = 12), 
    plot.title = element_text(face = 'bold', size = 20)
  )
```

We see that we have a lot of missing values for **nation_jersey_number**, **nation_team_id**, and **goalkeeping_speed**. We discussed these missing values above. We also have some missing values for other attributes such as **defending**, **dribbling**, **pace**, etc. This is because some players are not given certain ratings, usually because they do not do those things (i.e. goalkeeping). Some of these values might also be missing because they were not attributes in the earlier years of the game. Either way, we will pay close attention to these missing values if we are going to be using these variables for our analysis. 

We wanted to try and use the **missing_values** function from the **redav** package, but there are far too many columns in our dataset for the plots to be meaningful or look clean. Thus, we will stick with this simple analysis for now and pay close attention to the missing values. 





